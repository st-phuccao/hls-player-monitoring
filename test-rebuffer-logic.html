<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rebuffer Logic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .metrics {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }

        button {
            margin: 5px;
            padding: 8px 16px;
            cursor: pointer;
        }

        .status {
            font-weight: bold;
            margin: 10px 0;
        }

        .rebuffer-active {
            color: red;
        }

        .startup-measuring {
            color: blue;
        }
    </style>
</head>

<body>
    <h1>Test Rebuffer Logic Chuáº©n</h1>

    <div class="test-section">
        <h2>Video Element</h2>
        <video id="testVideo" width="400" height="300" style="background: #000;">
            Your browser does not support the video tag.
        </video>
        <br>
        <button onclick="loadTestStream()">Load Test Stream</button>
        <button onclick="testVideo.play()">Play</button>
        <button onclick="testVideo.pause()">Pause</button>
        <button onclick="simulateSeek()">Simulate Seek</button>
        <button onclick="simulateNetworkIssue()">Simulate Network Issue</button>
    </div>

    <div class="test-section">
        <h2>Rebuffer Metrics</h2>
        <div class="metrics" id="metricsDisplay">
            <div>Rebuffer Count: <span id="rebufferCount">0</span></div>
            <div>Rebuffer Duration: <span id="rebufferDuration">0.00s</span></div>
            <div>Watch Time: <span id="watchTime">0.00s</span></div>
            <div>Rebuffer Ratio: <span id="rebufferRatio">0.00%</span></div>
            <div>Status: <span id="status">Ready</span></div>
            <div>Is First Playing: <span id="isFirstPlaying">true</span></div>
            <div>Min Duration: <span id="minDuration">250ms</span></div>
        </div>
    </div>

    <div class="test-section">
        <h2>Event Log</h2>
        <div id="eventLog"
            style="height: 200px; overflow-y: scroll; background: #f9f9f9; padding: 10px; font-family: monospace; font-size: 12px;">
        </div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="resetMetrics()">Reset Metrics</button>
        <button onclick="updateMinDuration(100)">Set Min Duration 100ms</button>
        <button onclick="updateMinDuration(500)">Set Min Duration 500ms</button>
        <button onclick="hideTab()">Hide Tab (Test Visibility)</button>
    </div>

    <script type="module">
        import PerformanceTracker from './js/core/PerformanceTracker.js';

        let performanceTracker;
        let testVideo;
        let updateInterval;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            testVideo = document.getElementById('testVideo');
            performanceTracker = new PerformanceTracker();

            // Attach video element
            performanceTracker.attachVideoElement(testVideo);

            // Start real-time updates
            updateInterval = setInterval(updateDisplay, 500);

            logEvent('PerformanceTracker initialized with event-based detection');
        });

        function updateDisplay() {
            const metrics = performanceTracker.getRebufferMetrics();
            const config = performanceTracker.getRebufferConfig();

            document.getElementById('rebufferCount').textContent = metrics.rebuffer_count;
            document.getElementById('rebufferDuration').textContent = metrics.rebuffer_duration.toFixed(2) + 's';
            document.getElementById('watchTime').textContent = metrics.total_watch_time.toFixed(2) + 's';
            document.getElementById('rebufferRatio').textContent = metrics.rebuffer_ratio.toFixed(2) + '%';
            document.getElementById('isFirstPlaying').textContent = config.isFirstPlaying;
            document.getElementById('minDuration').textContent = config.minRebufferDuration + 'ms';

            const statusElement = document.getElementById('status');
            if (config.isWaitingForBuffer) {
                statusElement.textContent = 'Rebuffering...';
                statusElement.className = 'rebuffer-active';
            } else if (config.isFirstPlaying) {
                statusElement.textContent = 'Startup';
                statusElement.className = 'startup-measuring';
            } else {
                statusElement.textContent = 'Playing';
                statusElement.className = '';
            }
        }

        function logEvent(message) {
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        // Global functions for buttons
        window.loadTestStream = function () {
            // Use a test HLS stream
            const testUrl = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
            testVideo.src = testUrl;
            logEvent('Test stream loaded: ' + testUrl);
        };

        window.simulateSeek = function () {
            if (testVideo.duration > 0) {
                const newTime = Math.random() * testVideo.duration;
                testVideo.currentTime = newTime;
                logEvent(`Simulated seek to ${newTime.toFixed(2)}s`);
            }
        };

        window.simulateNetworkIssue = function () {
            // Simulate network issue by pausing and resuming after delay
            testVideo.pause();
            logEvent('Simulated network issue - pausing video');

            setTimeout(() => {
                testVideo.play();
                logEvent('Network issue resolved - resuming video');
            }, 2000);
        };

        window.resetMetrics = function () {
            performanceTracker.resetRebufferMetrics();
            logEvent('Metrics reset');
        };

        window.updateMinDuration = function (duration) {
            performanceTracker.updateRebufferConfig({ minRebufferDuration: duration });
            logEvent(`Min rebuffer duration updated to ${duration}ms`);
        };

        window.hideTab = function () {
            // Simulate tab visibility change
            Object.defineProperty(document, 'hidden', { value: true, configurable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            logEvent('Tab hidden (simulated)');

            setTimeout(() => {
                Object.defineProperty(document, 'hidden', { value: false, configurable: true });
                document.dispatchEvent(new Event('visibilitychange'));
                logEvent('Tab visible (simulated)');
            }, 3000);
        };

        window.clearLog = function () {
            document.getElementById('eventLog').innerHTML = '';
        };

        // Add video event listeners for logging
        testVideo.addEventListener('play', () => logEvent('Video: play'));
        testVideo.addEventListener('playing', () => logEvent('Video: playing (first frame)'));
        testVideo.addEventListener('pause', () => logEvent('Video: pause'));
        testVideo.addEventListener('waiting', () => logEvent('Video: waiting (potential rebuffer)'));
        testVideo.addEventListener('stalled', () => logEvent('Video: stalled'));
        testVideo.addEventListener('seeking', () => logEvent('Video: seeking'));
        testVideo.addEventListener('seeked', () => logEvent('Video: seeked'));
        testVideo.addEventListener('timeupdate', () => {
            // Log timeupdate less frequently
            if (Math.random() < 0.01) { // 1% chance
                logEvent(`Video: timeupdate (${testVideo.currentTime.toFixed(2)}s)`);
            }
        });
    </script>
</body>

</html>